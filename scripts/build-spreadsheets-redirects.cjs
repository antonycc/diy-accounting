#!/usr/bin/env node
// SPDX-License-Identifier: AGPL-3.0-only
// Copyright (C) 2026 DIY Accounting Ltd
//
// build-spreadsheets-redirects.cjs — Generate CloudFront Function from redirects.toml
//
// Usage:
//   node scripts/build-spreadsheets-redirects.cjs
//
// Reads:  web/spreadsheets.diyaccounting.co.uk/redirects.toml
// Writes: web/spreadsheets.diyaccounting.co.uk/redirect-function.js

const fs = require("fs");
const path = require("path");

const ROOT = path.resolve(__dirname, "..");
const TOML_PATH = path.join(ROOT, "web", "spreadsheets.diyaccounting.co.uk", "redirects.toml");
const OUTPUT_PATH = path.join(ROOT, "web", "spreadsheets.diyaccounting.co.uk", "redirect-function.js");

// Minimal TOML parser (supports our subset: key=value, [[array-of-tables]], [table])
function parseTOML(src) {
  var res = {};
  var currentSection = res;
  var lines = src.split(/\r?\n/);

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line || line.startsWith("#")) continue;

    // Array of tables: [[name]]
    if (line.startsWith("[[")) {
      var name = line.substring(2, line.lastIndexOf("]]")).trim();
      if (!res[name]) res[name] = [];
      var entry = {};
      res[name].push(entry);
      currentSection = entry;
      continue;
    }

    // Table: [name]
    if (line.startsWith("[")) {
      var tname = line.substring(1, line.lastIndexOf("]")).trim();
      if (!res[tname]) res[tname] = {};
      currentSection = res[tname];
      continue;
    }

    // Key = value
    var eqIdx = line.indexOf("=");
    if (eqIdx === -1) continue;
    var key = line.substring(0, eqIdx).trim();
    var val = line.substring(eqIdx + 1).trim();

    // Parse value
    if (val.startsWith('"') && val.endsWith('"')) {
      val = val.substring(1, val.length - 1);
    } else if (val === "true") {
      val = true;
    } else if (val === "false") {
      val = false;
    } else if (!isNaN(val) && val !== "") {
      val = Number(val);
    }

    currentSection[key] = val;
  }

  return res;
}

// Read and parse config
var tomlSrc = fs.readFileSync(TOML_PATH, "utf8");
var config = parseTOML(tomlSrc);
var redirects = config.redirect || [];
var productMap = config.product_map || {};

// Build the static redirect map as a JS object literal
var staticLines = [];
for (var r of redirects) {
  staticLines.push("    " + JSON.stringify(r.from) + ": { to: " + JSON.stringify(r.to) + ", t: " + JSON.stringify(r.target) + " }");
}
var staticMapStr = "{\n" + staticLines.join(",\n") + "\n  }";

// Build the product map as a JS object literal
var prodLines = [];
for (var oldId of Object.keys(productMap)) {
  if (productMap[oldId]) {
    prodLines.push("    " + JSON.stringify(oldId) + ": " + JSON.stringify(productMap[oldId]));
  }
}
var prodMapStr = "{\n" + prodLines.join(",\n") + "\n  }";

// Generate CloudFront Function (JS 2.0 runtime)
var functionCode = `// Auto-generated by scripts/build-spreadsheets-redirects.cjs — do not edit
// Redirects old www.diyaccounting.co.uk URLs to new locations
function handler(event) {
  var request = event.request;
  var uri = request.uri;
  var qs = request.querystring;
  var host = (request.headers.host && request.headers.host.value) || '';

  // Detect environment from Host header
  var isCI = host.indexOf('ci-') === 0;

  // Environment-specific target hosts
  var hosts = {
    spreadsheets: isCI ? 'ci-spreadsheets.diyaccounting.co.uk' : 'spreadsheets.diyaccounting.co.uk',
    submit: isCI ? 'ci.submit.diyaccounting.co.uk' : 'submit.diyaccounting.co.uk'
  };

  // Static redirect map
  var redirectMap = ${staticMapStr};

  // Product ID mapping (old → new)
  var productMap = ${prodMapStr};

  // Helper: return 301 redirect
  function redirect(url) {
    return {
      statusCode: 301,
      statusDescription: 'Moved Permanently',
      headers: {
        'location': { value: url },
        'cache-control': { value: 'max-age=86400' }
      }
    };
  }

  // Helper: build target URL
  function targetUrl(target, path) {
    if (target === 'self') return path;
    return 'https://' + hosts[target] + path;
  }

  // 1. Check static redirect map (exact path match)
  var rule = redirectMap[uri];
  if (rule) {
    // For pages that accept query params, handle special routing
    if (uri === '/article.html' && qs.article) {
      var articleId = (typeof qs.article === 'object') ? qs.article.value : qs.article;
      if (articleId) {
        var slug = articleId
          .replace(/Article$/, '')
          .replace(/([A-Z])/g, '-$1')
          .toLowerCase()
          .replace(/^-/, '')
          .replace(/--+/g, '-');
        return redirect(targetUrl('spreadsheets', '/articles/' + slug + '.md'));
      }
    }
    if (uri === '/product.html' && qs.product) {
      var prodId = (typeof qs.product === 'object') ? qs.product.value : qs.product;
      var newId = productMap[prodId];
      if (newId) {
        return redirect(targetUrl('spreadsheets', '/download.html?product=' + newId));
      }
      return redirect(targetUrl('spreadsheets', '/'));
    }
    if (uri === '/feature.html') {
      return redirect(targetUrl('spreadsheets', '/knowledge-base.html'));
    }
    // Self-target means rewrite URI (no external redirect)
    if (rule.t === 'self') {
      request.uri = rule.to;
      return request;
    }
    return redirect(targetUrl(rule.t, rule.to));
  }

  // 2. Path prefix: /zips/* → spreadsheets
  if (uri.indexOf('/zips/') === 0) {
    return redirect(targetUrl('spreadsheets', uri));
  }

  // 3. Path prefix: /content/* → 410 Gone (old JSON API)
  if (uri.indexOf('/content/') === 0) {
    return {
      statusCode: 410,
      statusDescription: 'Gone',
      headers: {
        'content-type': { value: 'text/plain' },
        'cache-control': { value: 'max-age=86400' }
      },
      body: 'This API endpoint has been discontinued. Visit https://feature-b.spreadsheets.diyaccounting.co.uk/ for current content.'
    };
  }

  // 4. Pass through to origin (index.html, about.html, etc.)
  return request;
}
`;

fs.writeFileSync(OUTPUT_PATH, functionCode, "utf8");
console.log("CloudFront Function written to " + OUTPUT_PATH);
console.log("Static redirects: " + redirects.length);
console.log("Product mappings: " + Object.keys(productMap).length);

// Validate size (CloudFront Functions have 10KB limit)
var sizeKB = Buffer.byteLength(functionCode, "utf8") / 1024;
console.log("Function size: " + sizeKB.toFixed(1) + "KB / 10KB limit");
if (sizeKB > 10) {
  console.error("ERROR: Function exceeds 10KB CloudFront Functions limit!");
  process.exit(1);
}
