#!/usr/bin/env node
// SPDX-License-Identifier: AGPL-3.0-only
// Copyright (C) 2026 DIY Accounting Ltd
//
// build-spreadsheets-redirects.cjs — Generate CloudFront Function from redirects.toml
//
// Usage:
//   node scripts/build-spreadsheets-redirects.cjs
//
// Reads:  web/spreadsheets.diyaccounting.co.uk/redirects.toml
// Writes: web/spreadsheets.diyaccounting.co.uk/redirect-function.js

const fs = require("fs");
const path = require("path");

const ROOT = path.resolve(__dirname, "..");
const TOML_PATH = path.join(ROOT, "web", "spreadsheets.diyaccounting.co.uk", "redirects.toml");
const OUTPUT_PATH = path.join(ROOT, "web", "spreadsheets.diyaccounting.co.uk", "redirect-function.js");

// Minimal TOML parser (supports our subset: key=value, [[array-of-tables]], [table])
function parseTOML(src) {
  var res = {};
  var currentSection = res;
  var lines = src.split(/\r?\n/);

  for (var i = 0; i < lines.length; i++) {
    var line = lines[i].trim();
    if (!line || line.startsWith("#")) continue;

    // Array of tables: [[name]]
    if (line.startsWith("[[")) {
      var name = line.substring(2, line.lastIndexOf("]]")).trim();
      if (!res[name]) res[name] = [];
      var entry = {};
      res[name].push(entry);
      currentSection = entry;
      continue;
    }

    // Table: [name]
    if (line.startsWith("[")) {
      var tname = line.substring(1, line.lastIndexOf("]")).trim();
      if (!res[tname]) res[tname] = {};
      currentSection = res[tname];
      continue;
    }

    // Key = value
    var eqIdx = line.indexOf("=");
    if (eqIdx === -1) continue;
    var key = line.substring(0, eqIdx).trim();
    var val = line.substring(eqIdx + 1).trim();

    // Parse value
    if (val.startsWith('"') && val.endsWith('"')) {
      val = val.substring(1, val.length - 1);
    } else if (val === "true") {
      val = true;
    } else if (val === "false") {
      val = false;
    } else if (!isNaN(val) && val !== "") {
      val = Number(val);
    }

    currentSection[key] = val;
  }

  return res;
}

// Read and parse config
var tomlSrc = fs.readFileSync(TOML_PATH, "utf8");
var config = parseTOML(tomlSrc);
var redirects = config.redirect || [];

// Build the static redirect map as a JS object literal
var staticLines = [];
for (var r of redirects) {
  staticLines.push("    " + JSON.stringify(r.from) + ": { to: " + JSON.stringify(r.to) + ", t: " + JSON.stringify(r.target) + " }");
}
var staticMapStr = "{\n" + staticLines.join(",\n") + "\n  }";

// Generate CloudFront Function (JS 2.0 runtime)
var functionCode = `// Auto-generated by scripts/build-spreadsheets-redirects.cjs — do not edit
// CloudFront Function for URL redirects
function handler(event) {
  var request = event.request;
  var uri = request.uri;
  var host = (request.headers.host && request.headers.host.value) || '';

  // Detect environment from Host header
  var isCI = host.indexOf('ci-') === 0;

  // Environment-specific target hosts
  var hosts = {
    spreadsheets: isCI ? 'ci-spreadsheets.diyaccounting.co.uk' : 'spreadsheets.diyaccounting.co.uk',
    submit: isCI ? 'ci.submit.diyaccounting.co.uk' : 'submit.diyaccounting.co.uk'
  };

  // Static redirect map
  var redirectMap = ${staticMapStr};

  // Helper: return 301 redirect
  function redirect(url) {
    return {
      statusCode: 301,
      statusDescription: 'Moved Permanently',
      headers: {
        'location': { value: url },
        'cache-control': { value: 'max-age=86400' }
      }
    };
  }

  // Helper: build target URL
  function targetUrl(target, path) {
    if (target === 'self') return path;
    return 'https://' + hosts[target] + path;
  }

  // Check static redirect map (exact path match)
  var rule = redirectMap[uri];
  if (rule) {
    // Self-target means rewrite URI (no external redirect)
    if (rule.t === 'self') {
      request.uri = rule.to;
      return request;
    }
    return redirect(targetUrl(rule.t, rule.to));
  }

  // Pass through to origin
  return request;
}
`;

fs.writeFileSync(OUTPUT_PATH, functionCode, "utf8");
console.log("CloudFront Function written to " + OUTPUT_PATH);
console.log("Static redirects: " + redirects.length);

// Validate size (CloudFront Functions have 10KB limit)
var sizeKB = Buffer.byteLength(functionCode, "utf8") / 1024;
console.log("Function size: " + sizeKB.toFixed(1) + "KB / 10KB limit");
if (sizeKB > 10) {
  console.error("ERROR: Function exceeds 10KB CloudFront Functions limit!");
  process.exit(1);
}
